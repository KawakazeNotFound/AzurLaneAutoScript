# Event Recognition Materials Location and New Event Addition Guide

## Recognition Materials Location

Recognition materials (image assets) for each new event are distributed in the following locations:

### 1. Event Recognition Materials (Assets)

Event recognition materials (image resources) are stored in the `assets` directory, organized by server:

```
assets/
├── cn/          # CN server assets
│   ├── event/   # Generic event recognition materials (e.g., escort events)
│   ├── campaign/# Stage entrance recognition materials
│   └── ...
├── en/          # EN server assets
│   ├── event/
│   ├── campaign/
│   └── ...
├── jp/          # JP server assets
│   ├── event/
│   ├── campaign/
│   └── ...
└── tw/          # TW server assets
    ├── event/
    ├── campaign/
    └── ...
```

#### Recognition Materials Explanation:

- **Generic Event Materials** (`assets/[server]/event/`):
  - Used to recognize event entrances, event UI elements, etc.
  - Example: `ESCORT_CHECK.png` (escort event detection)
  - Example: `MAIN_GOTO_ESCORT.png` (main screen to escort entrance)

- **Stage Recognition Materials** (`assets/[server]/campaign/`):
  - Used to recognize stage names, stage buttons, etc.
  - These materials are automatically generated by `dev_tools/button_extract.py`

### 2. Event Map Files (Campaign Maps)

Event map files are stored in the `campaign` directory:

```
campaign/
├── event_20200227_cn/    # Event directory (format: event_date_server)
│   ├── campaign_base.py  # Event base class
│   ├── sp.py            # SP stage configuration
│   ├── sp1.py           # SP1 stage map
│   ├── sp2.py           # SP2 stage map
│   └── ...
├── event_20220818_cn/
├── raid_20200624/        # Raid events
└── war_archives_xxxxx/   # War archives (permanent events)
```

#### Map File Explanation:

Each event directory contains:
- `campaign_base.py`: Base configuration class for the event
- `sp.py`, `sp1.py`, `sp2.py`, etc.: Map data for each stage
  - Map shape (`MAP.shape`)
  - Map data (`MAP.map_data`): Enemy distribution, obstacles, etc.
  - Camera data (`MAP.camera_data`): View switching points
  - Spawn data (`MAP.spawn_data`): Enemy spawn rules
  - Grid definitions: A1, B1, C1, etc. (map coordinates)

### 3. Event Modules (Module)

Event-related logic code is in the `module` directory:

```
module/
├── event/              # Generic event module
│   ├── assets.py      # Event recognition material definitions (auto-generated)
│   ├── campaign_sp.py # SP stage logic
│   ├── campaign_abcd.py # ABCD stage logic
│   └── maritime_escort.py # Maritime escort event
├── event_hospital/    # Hospital event module
├── eventstory/        # Event story module
└── campaign/          # Generic campaign module
    ├── assets.py      # Campaign recognition material definitions
    ├── campaign_ui.py # Campaign UI interaction
    └── run.py         # Campaign run logic
```

## How to Add a New Event

### Step 1: Prepare Recognition Materials

1. **Capture game screenshots**:
   - Resolution must be **1280x720**
   - Use emulator or game screenshot tools
   - Screenshots should include the UI elements that need to be recognized

2. **Save materials to the appropriate location**:
   ```
   # If it's a generic event element (e.g., new event type entrance)
   assets/cn/event/NEW_BUTTON.png
   assets/en/event/NEW_BUTTON.png
   assets/jp/event/NEW_BUTTON.png
   assets/tw/event/NEW_BUTTON.png
   
   # If it's stage-related
   assets/cn/campaign/STAGE_ENTRANCE.png
   # ...other servers
   ```

3. **Run button extraction tool** (optional, for auto-generating assets.py):
   ```bash
   cd /path/to/AzurLaneAutoScript
   python -m dev_tools.button_extract
   ```
   This will automatically scan the `assets` directory and generate `module/*/assets.py` files.

### Step 2: Create Event Directory and Map Files

1. **Create event directory**:
   ```bash
   mkdir campaign/event_YYYYMMDD_[server]
   ```
   - `YYYYMMDD`: Date when the event first aired (format: year-month-day)
   - `[server]`: Server identifier (cn/en/jp/tw)

2. **Create map files**:
   
   Refer to existing event directories (e.g., `campaign/event_20220818_cn/`) and create the following files:
   
   - `campaign_base.py`: Inherit base class, define event-specific configurations
   - `sp1.py`, `sp2.py`, etc.: Map data for each stage

   **Map File Template** (`sp1.py`):
   ```python
   from .campaign_base import CampaignBase
   from module.map.map_base import CampaignMap
   from module.map.map_grids import SelectedGrids, RoadGrids
   from module.logger import logger

   MAP = CampaignMap('SP1')
   MAP.shape = 'I7'  # Map size (columns x rows)
   MAP.camera_data = ['D4', 'E5', 'F4']  # Camera viewpoint positions
   MAP.camera_data_spawn_point = ['D3']  # Spawn point camera position
   MAP.map_data = """
       -- ++ -- SP -- SP -- ++ ++
       -- ++ -- -- -- -- -- ME --
       ME -- -- -- MS -- -- -- ME
       -- -- Me ++ Me ++ Me -- --
       ME -- -- -- __ -- -- -- ME
       -- ++ ++ ME -- ME -- ME --
       -- -- ++ -- MB -- ++ ++ ++
   """
   # Legend:
   # -- : Empty space
   # ++ : Obstacle
   # ME : Enemy fleet
   # MB : Boss
   # MS : Siren elite
   # SP : Special point
   # __ : Starting point

   MAP.weight_data = """
       50 50 50 50 50 50 50 50 50
       50 50 50 50 50 50 50 50 50
       ...
   """
   # Weight data: Used for path planning, lower values have higher priority

   MAP.spawn_data = [
       {'battle': 0, 'enemy': 2, 'siren': 1},
       {'battle': 1, 'enemy': 2},
       {'battle': 2, 'enemy': 1},
       {'battle': 3, 'enemy': 1},
       {'battle': 4, 'boss': 1},
   ]
   # Spawn rules: Enemy spawns after each battle

   # Grid definitions (auto-generated)
   A1, B1, C1, D1, E1, F1, G1, H1, I1, \
   A2, B2, C2, D2, E2, F2, G2, H2, I2, \
   ...
       = MAP.flatten()

   class Config:
       # Event-specific configuration
       MAP_SIREN_TEMPLATE = ['ShipName1', 'ShipName2']  # Siren templates
       MOVABLE_ENEMY_TURN = (2,)  # Movable enemy turns
       MAP_HAS_SIREN = True
       MAP_HAS_MOVABLE_ENEMY = True
   ```

### Step 3: Update Event List

Edit `campaign/Readme.md` and add a new row to the event list table:

```markdown
| Aired Date | Directory                | Event Name           | CN         | EN         | JP         | TW         |
| :--------- | :----------------------- | :------------------- | :--------- | :--------- | :--------- | :--------- |
| YYYYMMDD   | event_YYYYMMDD_cn        | Event English Name   | 活动中文名 | Event Name | イベント名 | 活動中文名 |
```

**Field Explanation**:
- **Aired Date**: Date when the event first aired (YYYYMMDD format)
- **Directory**: Event directory name (use underscores `_` instead of spaces)
- **Event Name**: Official English name (if not aired on EN, use CN name)
- **CN/EN/JP/TW**: GUI display names for each server (use `-` for servers where event hasn't aired)
  - If it's a rerun, you can add "Rerun" or "复刻" prefix
  - If it's war archives, "archives" prefix will be added automatically

### Step 4: Run Configuration Update Tool

```bash
cd /path/to/AzurLaneAutoScript
python -m module.config.config_updater
```

This tool will:
- Read the event list from `campaign/Readme.md`
- Automatically generate `module/config/config_generated.py`
- Update GUI configuration, making the new event selectable in the interface

### Step 5: Test the Event

1. **Start Alas**:
   ```bash
   python gui.py
   ```

2. **Select the new event in GUI**:
   - Go to the "Campaign" page
   - Select the newly added event from the event dropdown
   - Select the corresponding stage (SP1, SP2, etc.)

3. **Run and verify**:
   - Observe if the script can correctly recognize the event entrance
   - Observe if the script can correctly navigate the map
   - Observe if the script can correctly engage in battles

4. **Check logs**:
   - Normal logs: `log/YYYY-MM-DD.txt`
   - Error logs: `log/error/` directory

### Step 6: Submit Code

After confirming the tests are successful, commit your changes:

```bash
git add campaign/event_YYYYMMDD_*/
git add campaign/Readme.md
git add assets/*/event/*.png  # If there are new materials
git add assets/*/campaign/*.png  # If there are new materials
git commit -m "Add event: [Event Name]"
git push
```

## FAQ

### Q1: Must recognition materials be 1280x720 resolution?
**A**: Yes. Alas is designed to use 1280x720 resolution, and all recognition materials must be at this resolution.

### Q2: What if the event has different UI on different servers?
**A**: Prepare materials separately for each server and place them in the corresponding `assets/[server]/` directory.

### Q3: How do I know the meaning of symbols in map data?
**A**: Common symbols:
- `--`: Passable empty space
- `++`: Obstacle (impassable)
- `==`: Ocean (special terrain)
- `ME`: Normal enemy fleet
- `MB`: Boss fleet
- `MS`: Siren elite fleet
- `MA`: Ammunition supply point
- `SP`: Special point (e.g., puzzles, mechanisms)
- `__`: Fleet starting point
- `FL`: Fleet current location

### Q4: When do I need to run `button_extract.py`?
**A**: After adding new recognition materials (PNG images) to the `assets` directory, run this tool to automatically generate or update the `assets.py` file, which contains button position and color information.

### Q5: Do rerun events need a new directory?
**A**: Usually not. If the rerun event's map is identical to the original event, you can reuse the original event directory. Just add a new row in `campaign/Readme.md` pointing to the same Directory.

### Q6: How to debug map recognition issues?
**A**: 
1. Check error logs in the `log/error/` directory
2. Check screenshots to confirm if recognition materials match
3. Use `dev_tools/map_extractor.py` to assist in extracting map information
4. Enable debug mode to see detailed map recognition logs

## Development Tools

### button_extract.py
Automatically extracts button position and color information, generates `assets.py` files.

**Usage**:
```bash
python -m dev_tools.button_extract
```

### map_extractor.py
Tool to assist in extracting map information (requires manual operation and adjustment).

### config_updater.py
Updates configuration files, reads `campaign/Readme.md` and generates GUI configuration.

**Usage**:
```bash
python -m module.config.config_updater
```

## Reference Resources

- [Wiki Home](https://github.com/LmeSzinc/AzurLaneAutoScript/wiki)
- [Development Documentation](https://github.com/LmeSzinc/AzurLaneAutoScript/wiki/1.-Start)
- [Map Recognition Documentation](https://github.com/LmeSzinc/AzurLaneAutoScript/wiki/perspective)
- [FAQ](https://github.com/LmeSzinc/AzurLaneAutoScript/wiki/FAQ_en_cn)

## Contribution Guidelines

If you've added a new event and wish to contribute to the project:

1. Fork the project repository
2. Create a new branch: `git checkout -b add-event-xxxx`
3. Add the event following the steps above
4. Submit a Pull Request
5. In the PR, describe:
   - Event name and server
   - Testing status
   - Known issues (if any)

Thank you for contributing to the Alas project!
